name: Create Jira issue
on:
  issues:
    types: [opened]
  push:
    branches: [ mater ]

jobs:
  create-issue:
    name: Create Jira issue
    runs-on: ubuntu-latest
    steps:
      - name: Login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Process Issue Body
        id: process_body
        run: |
          ISSUE_URL="${{ github.event.issue.html_url }}"
          CREATOR="${{ github.event.issue.user.login }}"
          LABELS=$(echo '${{ toJson(github.event.issue.labels) }}' | jq -r '.[].name' | paste -sd "," -)
          
          BODY=$(echo '${{ github.event.issue.body }}' | sed 's/<!--.*-->//g' | awk '
          BEGIN {
            in_section = 0
          }
          /^## âœ¨ ì–´ë–¤ ê¸°ëŠ¥ì¸ê°€ìš”\?/ {
            print "h2. âœ¨ ì–´ë–¤ ê¸°ëŠ¥ì¸ê°€ìš”?"
            in_section = 1
            next
          }
          /^## ğŸ“š ì‘ì—… ìƒì„¸ ë‚´ìš©/ {
            print "\nh2. ğŸ“š ì‘ì—… ìƒì„¸ ë‚´ìš©"
            in_section = 2
            next
          }
          /^## ğŸ‘€ ì°¸ê³ í• ë§Œí•œ ìë£Œ/ {
            print "\nh2. ğŸ‘€ ì°¸ê³ í• ë§Œí•œ ìë£Œ(ì„ íƒ ì‚¬í•­)"
            in_section = 3
            next
          }
          in_section == 1 {print}
          in_section == 2 {print}
          in_section == 3 {print}
          ')
          echo "processed_body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Issue
        uses: atlassian/gajira-create@v3
        with:
          project: ISSUE
          issuetype: Task
          summary: '${{ github.event.issue.title }}'
          description: |
            h2. ì´ìŠˆ ìƒì„¸ ì •ë³´
            * GitHub Issue URL: ${{ github.event.issue.html_url }}
            * ìƒì„±ì: ${{ github.event.issue.user.login }}
            * ë¼ë²¨: ${{ join(github.event.issue.labels.*.name, ', ') }}
            
            ${{ steps.process_body.outputs.processed_body }}